<div class="container-fluid">
  <ng-container *ngIf="patterns?.length > 0">
    <div *ngFor="let pattern of patterns; let i = index" class="col">
      <label class="row col-form-label"
        >
        {{'submission.section.section-coar-notify.control.' + pattern + '.label' | translate }}
        </label
      >
      <div
        *ngFor="
          let service of ldnServiceByPattern[pattern];
          let serviceIndex = index
        "
      >
        <div class="row">
          <div ngbDropdown #myDropdown="ngbDropdown" class="w-100">
            <div class="position-relative right-addon" role="combobox">
              <i ngbDropdownToggle class="position-absolute scrollable-dropdown-toggle"
              aria-hidden="true"></i>
              <input
                type="text"
                [readonly]="true"
                ngbDropdownAnchor
                [ngClass]="{'border-danger': (getShownSectionErrors$(pattern, serviceIndex) | async)?.length > 0}"
                class="form-control w-100 scrollable-dropdown-input"
                [value]="ldnServiceByPattern[pattern][serviceIndex]?.name"
                (click)="myDropdown.open()"
              />
            </div>
            <div
              ngbDropdownMenu
              class="dropdown-menu scrollable-dropdown-menu w-100"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <div
                class="scrollable-menu"
                role="listbox"
                infiniteScroll
                [infiniteScrollDistance]="2"
                [infiniteScrollThrottle]="50"
                [scrollWindow]="false"
              >
                <button
                  *ngIf="(filterServices(pattern) | async)?.length == 0"
                  class="dropdown-item collection-item text-truncate w-100"
                >
                  {{'submission.section.section-coar-notify.dropdown.no-data' | translate}}
                </button>
                <button
                  *ngIf="(filterServices(pattern) | async)?.length > 0"
                  class="dropdown-item collection-item text-truncate w-100"
                  (click)="onChange(pattern, serviceIndex, null)"
                >
                {{'submission.section.section-coar-notify.dropdown.select-none' | translate}}
                </button>
                <button
                  *ngFor="let serviceOption of filterServices(pattern) | async"
                  [ngClass]="{'bg-light': ldnServiceByPattern[pattern][serviceIndex]?.id == serviceOption.id}"
                  class="dropdown-item collection-item text-truncate w-100"
                  (click)="onChange(pattern, serviceIndex, serviceOption)"
                >
                  <b>
                    {{ serviceOption.name }}
                  </b>
                  <br />
                  {{ serviceOption.description }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <small
          class="row text-muted"
          *ngIf="!ldnServiceByPattern[pattern][serviceIndex]"
        >
          {{'submission.section.section-coar-notify.small.notification' | translate : {pattern : pattern} }}
        </small>
        <ng-container *ngIf="(getShownSectionErrors$(pattern, serviceIndex) | async)?.length > 0">
          <small class="row text-danger" *ngFor="let error of (getShownSectionErrors$(pattern, serviceIndex) | async)">
            {{ error.message  | translate}}
          </small>
        </ng-container>
        <div
          class="row mt-1"
          *ngIf="ldnServiceByPattern[pattern][serviceIndex]"
        >
          <div
            class="alert alert-info w-100 d-flex align-items-center flex-row"
          >
            <i class="fa-solid fa-circle-info fa-xl ml-2"></i>
            <div class="ml-4">
              <div>{{ 'submission.section.section-coar-notify.selection.description' | translate }}</div>
              <div *ngIf="ldnServiceByPattern[pattern][serviceIndex]?.description; else noDesc">
                {{ ldnServiceByPattern[pattern][serviceIndex].description }}
              </div>
              <ng-template #noDesc>
                <span class="text-muted">
                  {{ 'submission.section.section-coar-notify.selection.no-description' | translate }}
                </span>
              </ng-template>
            </div>
          </div>
        </div>
        <div class="row" *ngIf="(getShownSectionErrors$(pattern, serviceIndex) | async)?.length > 0">
          <div
            class="alert alert-danger w-100 d-flex align-items-center flex-row"
          >
            <div class="ml-4">
              <span>
                {{ 'submission.section.section-coar-notify.notification.error' | translate }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
  <ng-container *ngIf="patterns?.length === 0">
    <p>
      {{'submission.section.section-coar-notify.info.no-pattern' | translate }}
    </p>
  </ng-container>
</div>
